<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Â¡MadeDis! - PUBLIC SAFE</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tilt+Neon&family=Courier+Prime:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        :root {
            --bg-dark: #050202;
            --glass-off: #2a1a1a; 
            --orange-gas: #ff6600; --orange-core: #fff5e6;
            --purple-gas: #bf00ff; --purple-core: #f5e6ff;
            --green-gas: #00ff66; --green-core: #e6fff0;
            --cyan-gas: #00f9ff; --cyan-core: #e6ffff;
        }

        body {
            font-family: 'Courier Prime', monospace;
            background-color: var(--bg-dark);
            background-image: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.9)), url("https://www.transparenttextures.com/patterns/dark-brick-wall.png");
            color: #888; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }
        body::after { content: ''; position: fixed; top:0; left:0; width:100%; height:100%; background: radial-gradient(circle at center, transparent 10%, black 140%); pointer-events: none; }

        /* NAV */
        .neon-font { font-family: 'Tilt Neon', sans-serif; }
        nav { padding: 30px 20px; display: flex; flex-direction: column; justify-content: center; align-items: center; background: rgba(0,0,0,0.4); z-index: 10; border-bottom: 1px solid #221111; gap: 20px; }
        .logo-container { font-family: 'Tilt Neon', sans-serif; font-size: 6rem; font-weight: 400; display: flex; align-items: baseline; letter-spacing: -8px; transform: rotate(-2deg); cursor: pointer; text-decoration: none; }
        .nav-controls { display: flex; gap: 20px; z-index: 11; }

        /* NEON TEXT */
        .tube-text { color: var(--glass-off); -webkit-text-stroke: 4px rgba(50, 30, 30, 0.5); transition: 0.2s; position: relative; }
        .lit-orange { color: var(--orange-core); -webkit-text-stroke: 0; text-shadow: 0 0 5px #fff, 0 0 20px var(--orange-gas), 0 0 50px var(--orange-gas); }
        .lit-purple { color: var(--purple-core); -webkit-text-stroke: 0; text-shadow: 0 0 5px #fff, 0 0 20px var(--purple-gas), 0 0 50px var(--purple-gas); }
        .logo-i { transform: rotate(180deg) translateY(5px); margin-right: -6px; animation: flicker-purple 5s infinite; }
        .logo-body { animation: hum-orange 0.1s infinite; }
        .logo-faulty { display:inline-block; animation: sputter-die 6s infinite; }
        .logo-end { margin-left: -5px; animation: hum-purple 4s infinite reverse; }

        /* UI ELEMENTS */
        .hidden { display: none !important; }
        .neon-border { border: 3px solid #2a2222; border-radius: 12px; background: rgba(10, 5, 5, 0.85); transition: 0.3s; position: relative; }
        .neon-border.active-orange { border-color: #fff; box-shadow: 0 0 5px #fff, 0 0 15px var(--orange-gas), inset 0 0 10px var(--orange-gas); }
        .neon-border.active-purple { border-color: #fff; box-shadow: 0 0 5px #fff, 0 0 15px var(--purple-gas), inset 0 0 10px var(--purple-gas); }
        .neon-border.active-green { border-color: #fff; box-shadow: 0 0 5px #fff, 0 0 15px var(--green-gas), inset 0 0 10px var(--green-gas); }

        .nav-btn { background: transparent; color: #664444; font-family: inherit; font-weight: bold; cursor: pointer; padding: 12px 30px; font-size: 0.9rem; letter-spacing: 1px; text-transform: uppercase; }
        .nav-btn:hover { color: var(--purple-core); text-shadow: 0 0 10px var(--purple-gas); border-color: #aa88aa; }
        .connect-btn { animation: pulse-purple-dim 3s infinite; }

        /* MAIN CONTENT */
        #view-upload { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 2; padding: 20px; }
        .intro-box { max-width: 600px; text-align: center; margin-bottom: 25px; color: #886666; font-size: 0.9rem; line-height: 1.6; text-shadow: 0 0 5px rgba(0,0,0,0.8); border-bottom: 1px dashed #332222; padding-bottom: 20px; margin-top: 20px; }
        .intro-highlight { color: var(--orange-gas); font-weight: bold; text-shadow: 0 0 10px var(--orange-gas); }

        .input-tabs { display: flex; gap: 20px; margin-bottom: 10px; }
        .tab-btn { background: transparent; border: none; color: #554444; font-family: 'Tilt Neon'; font-size: 1.2rem; cursor: pointer; padding-bottom: 5px; border-bottom: 2px solid transparent; }
        .tab-btn.active { color: var(--orange-core); text-shadow: 0 0 10px var(--orange-gas); border-bottom-color: var(--orange-gas); }

        .input-container { width: 100%; max-width: 600px; min-height: 200px; display: flex; flex-direction: column; cursor: pointer; margin-bottom: 20px;}
        .drop-area { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-bottom: 2px dashed #332222; padding: 20px;}
        #pasteArea { width: 100%; height: 200px; background: transparent; border: none; border-bottom: 2px dashed #332222; color: var(--orange-core); font-family: 'Courier Prime'; padding: 20px; resize: none; outline: none; display: none; }
        
        .ticker-panel { padding: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: center; font-size: 0.8rem;}
        .loading-dots:after { content: '.'; animation: dots 1s steps(5, end) infinite;}
        @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60% { content: '...'; } 80%, 100% { content: ''; } }

        .preview-drawer { width: 100%; max-width: 800px; height: 0; overflow: hidden; transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); opacity: 0; margin-bottom: 0; }
        .preview-drawer.open { height: 350px; opacity: 1; margin-bottom: 20px; }
        .browser-chrome { background: #111; padding: 8px 15px; display: flex; gap: 10px; border-bottom: 1px solid #333; align-items: center;}
        .dot { width: 10px; height: 10px; border-radius: 50%; background: #333; }

        .neon-btn-big { background: transparent; padding: 15px 30px; font-size: 1rem; font-weight: bold; letter-spacing: 2px; color: #553333; cursor: pointer; font-family: 'Tilt Neon', sans-serif; }
        .neon-btn-big:hover { color: #fff; text-shadow: 0 0 10px currentColor; }
        .action-buttons-container { display: flex; gap: 20px; margin-top: 10px; }

        /* DASHBOARD */
        #view-dashboard { flex-grow: 1; padding: 40px; display: flex; gap: 40px; z-index: 2; overflow-y: auto;}
        .preview-pane { flex: 4; animation: hum-border-orange 5s infinite; display: flex; flex-direction: column; min-height: 400px;}
        .data-pane { flex: 3; border-color: #553355; animation: hum-border-purple 4s infinite; display: flex; flex-direction: column; position: relative;}
        
        #certificateArea { background: linear-gradient(#150515, #050205); box-shadow: 0 0 20px rgba(191, 0, 255, 0.2); }
        .rank-header { text-align: center; padding: 20px; border-bottom: 2px dashed #442222; background: rgba(20, 0, 20, 0.5); }
        .rank-title { font-family:'Tilt Neon'; color:#ccaaff; text-shadow:0 0 10px var(--purple-gas); font-size: 1.5rem; }
        .rank-icon { font-size: 3rem; margin-top: 5px; animation: flicker-purple 3s infinite;}

        .ordinal-grid { padding: 20px; display: grid; grid-template-columns: 1fr; gap: 12px; font-size: 0.8rem; overflow-y: auto;}
        .data-row { display: flex; justify-content: space-between; border-bottom: 1px solid #332233; padding-bottom: 4px; }
        .d-label { color: #886688; }
        .d-val { color: var(--cyan-core); text-shadow: 0 0 5px var(--cyan-gas); font-family: monospace; text-align: right;}
        
        .stamp-overlay { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%) rotate(-15deg) scale(3); border: 8px solid var(--green-gas); border-radius: 20px; padding: 20px 30px; color: var(--green-gas); font-family: 'Tilt Neon', sans-serif; font-weight: bold; font-size: 2.5rem; text-shadow: 0 0 10px var(--green-gas), 0 0 20px var(--green-gas); box-shadow: 0 0 20px var(--green-gas), inset 0 0 20px var(--green-gas); opacity: 0; pointer-events: none; mix-blend-mode: screen; z-index: 10; text-align: center; line-height: 1.2; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .stamp-overlay svg { width: 50px; height: 50px; fill: var(--green-gas); filter: drop-shadow(0 0 5px var(--green-gas)); }
        .stamp-overlay.slam { animation: stamp-slam 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        /* KEYFRAME ANIMATIONS */
        @keyframes flicker-purple { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } 52% { opacity: 0.1; color: var(--glass-off); text-shadow: none; -webkit-text-stroke: 3px rgba(60,40,40,0.5); } 56% { opacity: 1; } }
        @keyframes sputter-die { 0%, 80% { color: var(--orange-core); text-shadow: 0 0 10px var(--orange-gas); -webkit-text-stroke: 0; } 85% { color: var(--glass-off); text-shadow: none; -webkit-text-stroke: 3px rgba(60,40,40,0.5); } 90% { opacity: 0.5; } 100% { opacity: 1; } }
        @keyframes hum-orange { 0%, 100% { filter: brightness(1); } 50% { filter: brightness(1.1); } }
        @keyframes hum-purple { 0%, 100% { filter: brightness(1); } 50% { filter: brightness(1.1); } }
        @keyframes hum-border-orange { 0%, 100% { border-color: #fff; box-shadow: 0 0 5px #fff, 0 0 15px var(--orange-gas), inset 0 0 10px var(--orange-gas); } 50% { border-color: #ffccaa; box-shadow: 0 0 2px #fff, 0 0 10px var(--orange-gas), inset 0 0 5px var(--orange-gas); } }
        @keyframes hum-border-purple { 0%, 100% { border-color: #fff; box-shadow: 0 0 5px #fff, 0 0 15px var(--purple-gas), inset 0 0 10px var(--purple-gas); } 50% { border-color: #eebbff; box-shadow: 0 0 2px #fff, 0 0 10px var(--purple-gas), inset 0 0 5px var(--purple-gas); } }
        @keyframes pulse-purple-dim { 0%, 100% { border-color: #442244; box-shadow: none; } 50% { border-color: #aa55aa; box-shadow: 0 0 5px var(--purple-gas); } }
        @keyframes stamp-slam { 0% { transform: translate(-50%, -50%) rotate(-15deg) scale(3); opacity: 0; } 100% { transform: translate(-50%, -50%) rotate(-15deg) scale(1); opacity: 0.8; } }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* MODALS */
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.95); display: flex; justify-content:center; align-items:center; z-index:100;}
        .wallet-window { width: 400px; padding: 30px; background: #000; animation: hum-border-purple 0.2s infinite; position:relative; }
        .spinner { width: 50px; height: 50px; border: 5px solid #331111; border-top: 5px solid var(--orange-gas); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px auto; box-shadow: 0 0 20px var(--orange-gas);}
        .tier-row { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px dashed #332222; }
        .tier-icon { font-size: 2rem; width: 50px; text-align: center; }
        .tier-desc { font-size: 0.8rem; color: #665555; }
        
        .api-input { width: 100%; padding: 10px; margin-top: 10px; background: #222; border: 1px solid #444; color: #fff; font-family: monospace; }

    </style>
</head>
<body>

    <nav>
        <a href="#" onclick="location.reload(); return false;" style="text-decoration:none;">
            <div class="logo-container">
                <span class="tube-text lit-purple logo-i">!</span>
                <span class="tube-text lit-orange logo-body">Ma<span class="logo-faulty">d</span>eDis</span>
                <span class="tube-text lit-purple logo-end">!</span>
            </div>
        </a>

        <div class="nav-controls">
            <button class="nav-btn neon-border active-green" onclick="showSettings()">
                âš™ SETTINGS
            </button>
            <button class="nav-btn neon-border active-purple" onclick="showTierModal()">
                ? RANK TIERS
            </button>
            <button class="nav-btn connect-btn neon-border" onclick="toggleWallet()">
                [ CONNECT WALLET ]
            </button>
        </div>
    </nav>

    <div id="view-upload">
        <div class="intro-box">
            <h2 class="neon-font lit-orange" style="margin: 0 0 10px 0;">ORIGINATE. DON'T DUPLICATE.</h2>
            <p>In the age of AI coding, <span class="intro-highlight">provenance is lost</span>. iMadeDis! is the first immutable registry. Timestamp your HTML on Bitcoin and prove you were the originator.</p>
        </div>

        <div class="input-tabs">
            <button class="tab-btn active" id="tabUpload" onclick="switchMode('upload')">UPLOAD FILE</button>
            <button class="tab-btn" id="tabPaste" onclick="switchMode('paste')">PASTE CODE</button>
        </div>

        <div class="input-container neon-border hover-light" id="inputContainer">
            <div class="drop-area" id="dropArea" onclick="triggerFileInput()">
                <div style="font-size: 3rem; margin-bottom: 10px; color:inherit;">â‡©</div>
                <div id="fileName" style="font-weight: bold; font-family: 'Tilt Neon', sans-serif;">DROP HTML OR CLICK TO BROWSE</div>
                <input type="file" id="realFileInput" style="display:none" accept=".html" onchange="handleFileSelect(this)">
            </div>
            <textarea id="pasteArea" placeholder="" oninput="handlePasteInput(this)"></textarea>
            <div class="ticker-panel">
                <div>FEE: <span id="feeDisplay" style="color:#aaa" class="loading-dots">fetching</span></div>
                <div id="estCost">COST: --</div>
            </div>
        </div>

        <div class="preview-drawer neon-border active-orange" id="previewDrawer">
            <div class="browser-chrome">
                <div class="dot" style="background:#ff5f56"></div>
                <div class="dot" style="background:#ffbd2e"></div>
                <div class="dot" style="background:#27c93f"></div>
                <div style="font-size:0.7rem; color:#666;">imadedis://preview-mode</div>
            </div>
            <div style="height:100%; background:white; position:relative;">
                <iframe id="previewFrame" style="width:100%; height:100%; border:none;"></iframe>
            </div>
        </div>

        <div class="action-buttons-container hidden" id="actionButtons">
            <button id="dibsBtn" class="neon-btn-big neon-border active-purple" onclick="showWalletModal()">INSCRIBE DIBS</button>
            <button id="demoBtn" class="neon-btn-big neon-border active-orange" onclick="runDemoTransaction()">DEMO MODE (SKIP)</button>
        </div>
    </div>

    <div id="view-dashboard" class="hidden">
        <div class="cabinet-panel neon-border preview-pane">
            <div class="browser-chrome">
                <div style="width:10px; height:10px; border-radius:50%; background:#ff4400; box-shadow:0 0 5px #ff4400;"></div>
                <div style="font-family:monospace; color:#ffaa00; font-size:0.8rem;">imadedis://provenance-view</div>
            </div>
            <div style="flex-grow:1; background:#fff; position:relative;">
                <iframe id="dashboardFrame" style="width:100%; height:100%; border:none;"></iframe>
            </div>
        </div>

        <div class="cabinet-panel neon-border data-pane" id="certificateArea">
            <div class="rank-header">
                <div class="rank-title">GENESIS DIBBER</div>
                <div class="rank-icon">âš¡</div>
            </div>
            
            <div class="stamp-overlay" id="certStamp">
                <svg viewBox="0 0 512 512"><path d="M504 256c0 136.967-111.033 248-248 248S8 392.967 8 256 119.033 8 256 8s248 111.033 248 248zm-141.663-66.792c-5.122-19.23-27.425-27.426-58.627-31.979l11.758-47.108c1.642-6.58-2.618-13.16-9.198-14.803l-35.343-8.823c-6.58-1.643-13.16 2.618-14.803 9.198l-11.238 45.02c-9.088-2.072-18.06-4.004-26.965-5.992l11.166-44.73c1.642-6.58-2.618-13.16-9.198-14.803l-35.343-8.823c-6.58-1.643-13.16 2.618-14.803 9.198l-11.332 45.4c-7.398-1.745-14.654-3.418-21.803-5.07L117.404 107c-6.58-1.642-13.16 2.618-14.803 9.198l-17.67 70.796c-.82 3.28.398 6.74 3.097 8.818 2.7 2.078 6.29 2.597 9.458 1.365l30.93-7.72c3.812-.95 7.76.57 9.53 3.674l.117.204c2.56 4.485 1.503 10.15-2.522 13.437l-10.233 41.003c.532.133 1.076.257 1.632.38.566.126 1.12.24 1.668.34l-10.42 41.748c-1.353 5.424 1.94 11.025 7.373 12.38l33.666 8.406c6.58 1.643 13.16-2.618 14.803-9.198l11.235-45.01c8.948 2.27 17.643 4.39 26.286 6.326l-11.31 45.31c-1.642 6.58 2.618 13.16 9.198 14.803l35.343 8.823c6.58 1.643 13.16-2.618 14.803-9.198l11.232-45.01c44.86 8.494 78.528 4.904 92.744-35.49 11.458-32.55-5.69-51.352-26.696-63.58 18.995-4.383 33.224-16.923 37.062-42.855zm-60.67 85.02c-8.216 32.918-64.24 15.124-82.392 10.593l14.706-58.917c18.152 4.532 76.293 13.376 67.686 48.324zm8.682-86.416c-7.514 30.106-53.945 14.8-68.85 11.08l13.344-53.46c14.906 3.72 62.77 10.424 55.506 42.38z"/></svg>
                <div>YOU MADE DIS!</div>
            </div>

            <div class="ordinal-grid">
                <div class="data-row"><span class="d-label">ID</span> <span class="d-val">d67a6248...948a</span></div>
                <div class="data-row"><span class="d-label">ADDRESS</span> <span class="d-val">bc1p57p0se7z...</span></div>
                <div class="data-row"><span class="d-label">VALUE</span> <span class="d-val">546 sats</span></div>
                <div class="data-row"><span class="d-label">SAT NAME</span> <span class="d-val" style="color:#bf00ff">hhpnxkrlbaq</span></div>
                <div class="data-row"><span class="d-label">SAT ID</span> <span class="d-val">9237659715438</span></div>
                <div class="data-row"><span class="d-label">CONTENT TYPE</span> <span class="d-val">text/html</span></div>
                <div class="data-row"><span class="d-label">TIMESTAMP</span> <span class="d-val">2026-01-11 20:45</span></div>
                <div class="data-row"><span class="d-label">HEIGHT</span> <span class="d-val">931884</span></div>
                <div class="data-row"><span class="d-label">FEE</span> <span class="d-val">4614 sats</span></div>
                <div class="data-row"><span class="d-label">LOCATION</span> <span class="d-val">d67a6248...:0:0</span></div>
            </div>

            <button class="neon-btn-big neon-border active-purple" style="width:100%; margin-top:20px; font-size:0.9rem;" onclick="downloadCertificate()">
                [ DOWNLOAD IMAGE ]
            </button>
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay hidden" onclick="closeSettings(event)">
        <div class="wallet-window neon-border active-green">
            <h2 class="neon-font lit-orange" style="text-align:center; margin-top:0;">APP SETTINGS</h2>
            <p style="color:#ccc; font-size:0.9rem;">To use the "Inscribe" feature, please enter your UniSat API Key below. It will be saved in your browser.</p>
            <input type="password" id="apiKeyInput" class="api-input" placeholder="Enter UniSat API Key">
            <button class="neon-btn-big neon-border active-green" style="width:100%; margin-top:20px;" onclick="saveApiKey()">SAVE KEY</button>
        </div>
    </div>

    <div id="tier-modal" class="modal-overlay hidden" onclick="closeTierModal(event)">
        <div class="wallet-window neon-border active-purple">
            <h2 class="neon-font lit-purple" style="text-align:center; margin-top:0;">RANKING PROTOCOL</h2>
            <div class="tier-row"><div class="tier-icon">âš¡</div><div><div class="neon-font lit-purple">GENESIS DIBBER</div><div class="tier-desc">First 100 Inscriptions.</div></div></div>
            <div class="tier-row"><div class="tier-icon">ðŸ”¥</div><div><div class="neon-font lit-orange">EARLY ADOPTER</div><div class="tier-desc">Inscriptions 101-1,000.</div></div></div>
            <div class="tier-row" style="border:none;"><div class="tier-icon">âœ…</div><div><div class="neon-font lit-green">VERIFIED</div><div class="tier-desc">Standard Proof.</div></div></div>
            <button class="neon-btn-big neon-border active-green" style="width:100%; margin-top:0;" onclick="document.getElementById('tier-modal').classList.add('hidden')">CLOSE</button>
        </div>
    </div>

    <div id="wallet-modal" class="modal-overlay hidden">
        <div class="wallet-window neon-border active-purple">
            <div style="text-align:center;">
                <h2 style="font-family:'Tilt Neon'; color:#fff; text-shadow:0 0 10px var(--purple-gas);">SIGNATURE REQUEST</h2>
                <div style="border:1px solid #553355; padding:15px; margin:20px 0; color:#eebbff;">TOTAL: <span id="finalBtcCost">--</span></div>
                <button class="neon-btn-big neon-border active-orange" style="width:100%; margin-top:0;" onclick="processTransaction()">PAY NOW</button>
            </div>
        </div>
    </div>

    <div id="loading-modal" class="modal-overlay hidden">
        <div style="text-align: center;">
            <div class="spinner"></div>
            <h2 id="loading-text" style="font-family:'Tilt Neon'; color:#fff; text-shadow:0 0 10px var(--orange-gas);">BROADCASTING...</h2>
        </div>
    </div>

    <script>
        // --- SECURE KEY MANAGEMENT ---
        let currentHTML = "";
        let btcPrice = 0;
        let feeRate = 0;
        let fileBytes = 0;
        let userAddress = null;

        // INIT
        window.onload = async () => {
            // Load saved key if exists
            const savedKey = localStorage.getItem('unisat_api_key');
            if(savedKey) console.log("API Key loaded from storage.");

            // Fetch Data
            try {
                const priceRes = await fetch('https://api.coindesk.com/v1/bpi/currentprice.json');
                const priceData = await priceRes.json();
                btcPrice = priceData.bpi.USD.rate_float;
            } catch(e) {}
            try {
                const feeRes = await fetch('https://mempool.space/api/v1/fees/recommended');
                const feeData = await feeRes.json();
                feeRate = feeData.fastestFee;
                document.getElementById('feeDisplay').innerText = feeRate + " s/vB";
                document.getElementById('feeDisplay').classList.remove('loading-dots');
                document.getElementById('feeDisplay').classList.add('lit-cyan');
            } catch(e) {}
        };

        // SETTINGS LOGIC
        function showSettings() { document.getElementById('settings-modal').classList.remove('hidden'); }
        function closeSettings(e) { if(e.target.id === 'settings-modal') e.target.classList.add('hidden'); }
        function saveApiKey() {
            const input = document.getElementById('apiKeyInput').value;
            if(input.length > 5) {
                localStorage.setItem('unisat_api_key', input);
                alert("API Key Saved Securely!");
                document.getElementById('settings-modal').classList.add('hidden');
            } else { alert("Invalid Key"); }
        }

        function toggleWallet() {
            if (typeof window.unisat !== 'undefined') {
                try {
                    window.unisat.requestAccounts().then(accounts => {
                        userAddress = accounts[0];
                        const btn = document.querySelector('.connect-btn');
                        btn.innerHTML = "[ " + userAddress.slice(0,6) + "..." + " ]";
                        btn.classList.add('active-purple');
                    });
                } catch (e) { alert("Connection failed."); }
            } else { alert("UniSat Wallet not installed!"); }
        }

        // --- UI LOGIC ---
        function showTierModal() { document.getElementById('tier-modal').classList.remove('hidden'); }
        function closeTierModal(e) { if(e.target.id === 'tier-modal') e.target.classList.add('hidden'); }
        function showWalletModal() { document.getElementById('wallet-modal').classList.remove('hidden'); }

        function switchMode(mode) {
            const drop = document.getElementById('dropArea');
            const paste = document.getElementById('pasteArea');
            const tabUp = document.getElementById('tabUpload');
            const tabPa = document.getElementById('tabPaste');
            const container = document.getElementById('inputContainer');

            if (mode === 'upload') {
                drop.style.display = 'flex'; paste.style.display = 'none';
                tabUp.classList.add('active'); tabPa.classList.remove('active');
                container.classList.remove('active-orange');
            } else {
                drop.style.display = 'none'; paste.style.display = 'block';
                tabUp.classList.remove('active'); tabPa.classList.add('active');
                container.classList.add('active-orange');
                paste.focus();
            }
        }

        function triggerFileInput() { document.getElementById('realFileInput').click(); }

        function handleFileSelect(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                reader.onload = function(e) { processContent(file.name, e.target.result); };
                reader.readAsText(file);
            }
        }

        function handlePasteInput(textarea) {
            if (textarea.value.length > 5) processContent("raw_code.html", textarea.value);
        }

        function processContent(name, content) {
            currentHTML = content;
            fileBytes = new Blob([content]).size;
            const container = document.getElementById('inputContainer');
            container.classList.remove('hover-light');
            container.classList.add('active-orange');
            if(document.getElementById('fileName')) document.getElementById('fileName').innerText = "> " + name;

            if (btcPrice > 0 && feeRate > 0) {
                const totalSats = (fileBytes + 300) * feeRate; 
                const costUSD = (totalSats / 100000000) * btcPrice;
                document.getElementById('estCost').innerText = "COST: $" + costUSD.toFixed(2);
                document.getElementById('estCost').style.color = "#ffaa00";
                document.getElementById('estCost').style.textShadow = "0 0 5px #ffaa00";
                document.getElementById('finalBtcCost').innerText = (totalSats/100000000).toFixed(6) + " BTC";
            } else {
                document.getElementById('estCost').innerText = "COST: ~$5.00";
            }

            document.getElementById('previewFrame').srcdoc = currentHTML;
            document.getElementById('previewDrawer').classList.add('open');
            document.getElementById('actionButtons').classList.remove('hidden');
        }

        function runDemoTransaction() {
            document.getElementById('loading-modal').classList.remove('hidden');
            document.getElementById('loading-text').innerText = "RUNNING DEMO SIMULATION...";
            const demoHTML = currentHTML || "<div style='color:orange; text-align:center; padding:50px; font-family:sans-serif;'><h1>DEMO INSCRIPTION</h1><p>This is a simulation.</p></div>";
            document.getElementById('dashboardFrame').srcdoc = demoHTML;
            setTimeout(() => {
                document.getElementById('loading-modal').classList.add('hidden');
                document.getElementById('view-upload').classList.add('hidden');
                document.getElementById('view-dashboard').classList.remove('hidden');
                setTimeout(() => { document.getElementById('certStamp').classList.add('slam'); }, 500);
            }, 2000);
        }

        async function processTransaction() {
            const apiKey = localStorage.getItem('unisat_api_key');
            if (!apiKey) {
                alert("Please click SETTINGS and enter your UniSat API Key first!");
                return;
            }
            if (!userAddress) { alert("Please connect wallet first!"); return; }

            document.getElementById('wallet-modal').classList.add('hidden');
            document.getElementById('loading-modal').classList.remove('hidden');
            document.getElementById('loading-text').innerText = "BROADCASTING...";

            try {
                const response = await fetch('https://open-api.unisat.io/v2/inscribe/order/create', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + apiKey, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        receiveAddress: userAddress,
                        feeRate: feeRate,
                        outputValue: 546,
                        files: [{ filename: "imadedis_proof.html", dataURL: "data:text/html;base64," + btoa(currentHTML) }]
                    })
                });
                const orderData = await response.json();
                if (orderData.code !== 0) throw new Error(orderData.msg);
                await window.unisat.sendBitcoin(orderData.data.payAddress, orderData.data.amount);
                
                document.getElementById('dashboardFrame').srcdoc = currentHTML;
                document.getElementById('loading-modal').classList.add('hidden');
                document.getElementById('view-upload').classList.add('hidden');
                document.getElementById('view-dashboard').classList.remove('hidden');
                setTimeout(() => { document.getElementById('certStamp').classList.add('slam'); }, 500);

            } catch (e) {
                console.error(e);
                alert("Error: " + e.message);
                document.getElementById('loading-modal').classList.add('hidden');
            }
        }

        function downloadCertificate() {
            const certArea = document.getElementById('certificateArea');
            html2canvas(certArea, { 
                scale: 3, 
                backgroundColor: "#050202",
                useCORS: true 
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'iMadeDis_Certificate.png';
                link.href = canvas.toDataURL("image/png");
                link.click();
            });
        }
    </script>
</body>
</html>
